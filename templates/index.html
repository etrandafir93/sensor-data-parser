<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <title>Sensor Data Parser</title>

    <link rel="stylesheet" href="../static/style.css">
</head>

<body>

    <h2>Import csv file with sensors output</h2>

    <div class="file-drop-area">
        <span class="fake-btn">Choose .csv file</span>
        <span class="file-msg">or drag and drop files here</span>
        <input class="file-input" id="up-file" type="file" accept=".csv">
    </div>

    <button type="button" class="btn btn-dark mt-4 pl-5 pr-5" onclick="sendData()" style="color:#cff0ef">
        Analyze data!
    </button>

    <div id="results" class="mt-4">
        <div class="row">
            <div id="temperature-chart" class="col chart-img"></div>
            <div id="humidity-chart" class="col chart-img"></div>
            <div id="speed-chart" class="col chart-img"></div>
        </div>
        <div class="row m-5">
            <div id="presence1-chart" class="col chart-img pie"></div>
            <div id="presence2-chart" class="col chart-img pie"></div>
        </div>
    </div> 

    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
        crossorigin="anonymous"></script>

    <script>

        window.onload = () => {
            document.getElementById('up-file').addEventListener('change', handleFileSelect, false);
        }

        function sendData() {

            // can either send the file or it's content
            // postCsvData(uploadedData, (responseText) => {
            //     requestCharts( JSON.parse(responseText) );
            // });

            postCsvFile(uploadedFile, (responseText) => {
                requestCharts(JSON.parse(responseText));
            });
        }

        function requestCharts(postResponse) {
            requestAndDisplaychart(postResponse.charts.html.temperature, "temperature-chart", 500);
            requestAndDisplaychart(postResponse.charts.html.humidity, "humidity-chart", 800);
            requestAndDisplaychart(postResponse.charts.html.speed, "speed-chart", 700);

            requestAndDisplaychart(postResponse.charts.html.presence1, "presence1-chart", 1000);
            requestAndDisplaychart(postResponse.charts.html.presence2, "presence2-chart", 500);
        }
 

        function requestAndDisplaychart(url, parentId, delay) {
            startSpinner(parentId);
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url);
            xhr.onload = function () {
                setTimeout( ()=>{ document.getElementById(parentId).innerHTML = this.responseText; } , delay );
            };
            xhr.setRequestHeader("Content-Type", "text/plain;charset=UTF-8");
            xhr.send(null);
        }

        function startSpinner(parentId){
            let spinnerHtml = `<div class="lds-hourglass"></div>`
            document.getElementById(parentId).innerHTML = spinnerHtml;
        }

        function handleFileSelect(evt) {

            var file = evt.target.files[0];
            window.uploadedFile = file;

            var reader = new FileReader();

            reader.onload = (function (file) {
                return function (data) {
                    console.log("fle uploaded", file);
                    window.uploadedData = data.target.result;
                };
            })(file);

            reader.readAsText(file);
        }

        var $fileInput = $('.file-input');
        var $droparea = $('.file-drop-area');

        // highlight drag area
        $fileInput.on('dragenter focus click', function () {
            $droparea.addClass('is-active');
        });

        // back to normal state
        $fileInput.on('dragleave blur drop', function () {
            $droparea.removeClass('is-active');
        });

        // change inner text
        $fileInput.on('change', function () {
            var filesCount = $(this)[0].files.length;
            var $textContainer = $(this).prev();

            if (filesCount === 1) {
                // if single file is selected, show file name
                var fileName = $(this).val().split('\\').pop();
                $textContainer.text(fileName);
            } else {
                // otherwise show number of files
                $textContainer.text(filesCount + ' files selected');
            }
        });

        function postCsvData(data, callback) {

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/csv_data/text');
            xhr.onload = function () {
                callback(this.responseText);
            };
            xhr.setRequestHeader("Content-Type", "text/plain;charset=UTF-8");
            xhr.send(data);
        }

        function postCsvFile(file, callback) {

            let formData = new FormData();
            formData.append("file", file, "data.csv");

            var xhr = new XMLHttpRequest();
            xhr.open('POST', "/csv_data/file");
            xhr.onload = function () {
                callback(this.responseText);
            };
            xhr.send(formData);
        }


    </script>
</body>

</html>